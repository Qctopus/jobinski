"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.PDFGenerator = void 0;
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const reports_1 = require("../../types/reports");
const ChartGenerator_1 = require("./ChartGenerator");
class PDFGenerator {
    constructor(publicDir = path.join(__dirname, '../../../../public')) {
        this.chartGenerator = new ChartGenerator_1.ChartGenerator();
        this.publicDir = publicDir;
    }
    generatePDFDocument(reportData) {
        const { metadata, agencyMetrics, benchmarks, competitiveIntelligence, insights, recommendations } = reportData;
        const charts = this.chartGenerator.generateAllCharts(agencyMetrics, benchmarks, competitiveIntelligence);
        const agencyColor = reports_1.AGENCY_COLORS[agencyMetrics.agencyInfo.shortName] || reports_1.AGENCY_COLORS['default'] || '#0468B1';
        return {
            pageSize: 'A4',
            pageMargins: [40, 60, 40, 60],
            header: (currentPage, pageCount) => {
                if (currentPage === 1)
                    return null;
                return {
                    columns: [
                        {
                            text: `${metadata.agency} HR Intelligence Report`,
                            margin: [40, 20, 0, 0],
                            fontSize: 9,
                            color: '#666666'
                        },
                        {
                            text: `Page ${currentPage} of ${pageCount}`,
                            alignment: 'right',
                            margin: [0, 20, 40, 0],
                            fontSize: 9,
                            color: '#666666'
                        }
                    ]
                };
            },
            footer: {
                columns: [
                    {
                        text: 'Generated by UN Jobs Analytics Platform',
                        alignment: 'center',
                        margin: [0, 20, 0, 0],
                        fontSize: 8,
                        color: '#999999'
                    }
                ]
            },
            content: [
                ...this.generateCoverPage(metadata, agencyMetrics, agencyColor),
                { text: '', pageBreak: 'after' },
                ...this.generateExecutiveSummary(agencyMetrics, benchmarks, insights),
                { text: '', pageBreak: 'after' },
                ...this.generateHiringActivitySection(agencyMetrics, benchmarks),
                { text: '', pageBreak: 'after' },
                ...this.generateWorkforceSection(agencyMetrics),
                { text: '', pageBreak: 'after' },
                ...this.generateStrategicSection(insights, recommendations)
            ],
            styles: {
                header: { fontSize: 24, bold: true, color: agencyColor },
                subheader: { fontSize: 16, bold: true, margin: [0, 15, 0, 5] },
                sectionTitle: { fontSize: 14, bold: true, color: agencyColor, margin: [0, 10, 0, 5] },
                body: { fontSize: 10, lineHeight: 1.4 },
                metric: { fontSize: 24, bold: true, color: agencyColor },
                metricLabel: { fontSize: 9, color: '#666666' },
                tableHeader: { fontSize: 10, bold: true, fillColor: '#f5f5f5' },
                tableCell: { fontSize: 9 }
            },
            defaultStyle: {
                fontSize: 10
            }
        };
    }
    generateCoverPage(metadata, metrics, agencyColor) {
        return [
            { text: '', margin: [0, 100, 0, 0] },
            {
                text: metrics.agencyInfo.longName || metrics.agencyInfo.shortName,
                style: 'header',
                alignment: 'center'
            },
            { text: '', margin: [0, 20, 0, 0] },
            {
                text: 'Monthly HR Intelligence Report',
                fontSize: 18,
                alignment: 'center',
                color: '#444444'
            },
            { text: '', margin: [0, 30, 0, 0] },
            {
                text: metadata.reportPeriod.displayPeriod,
                fontSize: 14,
                alignment: 'center',
                color: '#666666'
            },
            { text: '', margin: [0, 60, 0, 0] },
            {
                columns: [
                    {
                        width: '*',
                        stack: [
                            { text: 'Total Positions', style: 'metricLabel', alignment: 'center' },
                            { text: metrics.volumeMetrics.totalPostings.toString(), style: 'metric', alignment: 'center' }
                        ]
                    },
                    {
                        width: '*',
                        stack: [
                            { text: 'Active Openings', style: 'metricLabel', alignment: 'center' },
                            { text: metrics.volumeMetrics.activePostings.toString(), style: 'metric', alignment: 'center' }
                        ]
                    },
                    {
                        width: '*',
                        stack: [
                            { text: 'Countries', style: 'metricLabel', alignment: 'center' },
                            { text: metrics.geographicAnalysis.regionDistribution.length.toString(), style: 'metric', alignment: 'center' }
                        ]
                    }
                ]
            },
            { text: '', margin: [0, 80, 0, 0] },
            {
                text: `Generated: ${new Date(metadata.generatedAt).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                })}`,
                fontSize: 9,
                alignment: 'center',
                color: '#999999'
            }
        ];
    }
    generateExecutiveSummary(metrics, benchmarks, insights) {
        const content = [
            { text: 'Executive Summary', style: 'header', margin: [0, 0, 0, 20] }
        ];
        content.push({
            columns: [
                {
                    width: '25%',
                    stack: [
                        { text: 'Total Postings', style: 'metricLabel' },
                        { text: metrics.volumeMetrics.totalPostings.toLocaleString(), style: 'metric' },
                        {
                            text: `${metrics.volumeMetrics.monthOverMonthChange >= 0 ? '+' : ''}${metrics.volumeMetrics.monthOverMonthChange.toFixed(0)}% vs prev`,
                            fontSize: 9,
                            color: metrics.volumeMetrics.monthOverMonthChange >= 0 ? '#28a745' : '#dc3545'
                        }
                    ]
                },
                {
                    width: '25%',
                    stack: [
                        { text: 'Active Positions', style: 'metricLabel' },
                        { text: metrics.volumeMetrics.activePostings.toLocaleString(), style: 'metric' }
                    ]
                },
                {
                    width: '25%',
                    stack: [
                        { text: 'Avg Application Window', style: 'metricLabel' },
                        { text: `${metrics.applicationMetrics.avgApplicationWindow.toFixed(0)} days`, style: 'metric' }
                    ]
                },
                {
                    width: '25%',
                    stack: [
                        { text: 'Market Avg', style: 'metricLabel' },
                        { text: `${benchmarks.marketAverages.avgApplicationWindow.toFixed(0)} days`, fontSize: 14, color: '#666' }
                    ]
                }
            ],
            margin: [0, 0, 0, 30]
        });
        content.push({ text: 'Key Insights', style: 'sectionTitle' });
        const allInsights = [
            ...insights.volumeInsights.slice(0, 2),
            ...insights.competitiveInsights.slice(0, 2),
            ...insights.strategicInsights.slice(0, 2)
        ];
        content.push({
            ul: allInsights.map(insight => ({
                text: `${insight.title}: ${insight.description}`,
                margin: [0, 3, 0, 3]
            }))
        });
        return content;
    }
    generateHiringActivitySection(metrics, benchmarks) {
        const content = [
            { text: 'Section 1: Hiring Activity Analysis', style: 'header', margin: [0, 0, 0, 20] }
        ];
        content.push({ text: 'Position Volume', style: 'sectionTitle' });
        content.push({
            table: {
                widths: ['*', '*', '*', '*'],
                body: [
                    [
                        { text: 'Metric', style: 'tableHeader' },
                        { text: 'This Period', style: 'tableHeader' },
                        { text: 'Previous Period', style: 'tableHeader' },
                        { text: 'Change', style: 'tableHeader' }
                    ],
                    [
                        'Total Postings',
                        metrics.volumeMetrics.totalPostings.toString(),
                        metrics.volumeMetrics.previousMonthPostings.toString(),
                        `${metrics.volumeMetrics.monthOverMonthChange >= 0 ? '+' : ''}${metrics.volumeMetrics.monthOverMonthChange.toFixed(0)}%`
                    ],
                    [
                        'Active Positions',
                        metrics.volumeMetrics.activePostings.toString(),
                        '-',
                        '-'
                    ],
                    [
                        'Closing Soon (â‰¤14 days)',
                        metrics.volumeMetrics.closingSoonPostings.toString(),
                        '-',
                        '-'
                    ]
                ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 20]
        });
        content.push({ text: 'Application Windows', style: 'sectionTitle' });
        content.push({
            table: {
                widths: ['*', '*', '*'],
                body: [
                    [
                        { text: 'Metric', style: 'tableHeader' },
                        { text: 'Your Agency', style: 'tableHeader' },
                        { text: 'Market Average', style: 'tableHeader' }
                    ],
                    [
                        'Avg Application Window',
                        `${metrics.applicationMetrics.avgApplicationWindow.toFixed(0)} days`,
                        `${benchmarks.marketAverages.avgApplicationWindow.toFixed(0)} days`
                    ],
                    [
                        'Median Window',
                        `${metrics.applicationMetrics.medianApplicationWindow} days`,
                        '-'
                    ],
                    [
                        'Urgent Positions',
                        `${metrics.applicationMetrics.urgentPositionsCount} (${metrics.applicationMetrics.urgentPositionsPercentage.toFixed(0)}%)`,
                        '-'
                    ]
                ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 20]
        });
        return content;
    }
    generateWorkforceSection(metrics) {
        const content = [
            { text: 'Section 2: Workforce Composition', style: 'header', margin: [0, 0, 0, 20] }
        ];
        content.push({ text: 'Staff Type Distribution', style: 'sectionTitle' });
        const staffTypes = metrics.workforceComposition.staffTypeBreakdown;
        content.push({
            table: {
                widths: ['*', '*', '*'],
                body: [
                    [
                        { text: 'Staff Type', style: 'tableHeader' },
                        { text: 'Count', style: 'tableHeader' },
                        { text: 'Percentage', style: 'tableHeader' }
                    ],
                    ['International', staffTypes.international.count.toString(), `${staffTypes.international.percentage.toFixed(1)}%`],
                    ['National', staffTypes.national.count.toString(), `${staffTypes.national.percentage.toFixed(1)}%`],
                    ['Consultant', staffTypes.consultant.count.toString(), `${staffTypes.consultant.percentage.toFixed(1)}%`],
                    ['Intern', staffTypes.intern.count.toString(), `${staffTypes.intern.percentage.toFixed(1)}%`],
                    ['Other', staffTypes.other.count.toString(), `${staffTypes.other.percentage.toFixed(1)}%`]
                ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 20]
        });
        content.push({ text: 'Top Grade Levels', style: 'sectionTitle' });
        const topGrades = metrics.workforceComposition.gradeDistribution.slice(0, 10);
        content.push({
            table: {
                widths: ['*', '*', '*'],
                body: [
                    [
                        { text: 'Grade', style: 'tableHeader' },
                        { text: 'Count', style: 'tableHeader' },
                        { text: 'Percentage', style: 'tableHeader' }
                    ],
                    ...topGrades.map(g => [g.grade, g.count.toString(), `${g.percentage.toFixed(1)}%`])
                ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 20]
        });
        content.push({ text: 'Top Duty Stations', style: 'sectionTitle' });
        const topStations = metrics.geographicAnalysis.topDutyStations.slice(0, 10);
        content.push({
            table: {
                widths: ['*', '*', '*'],
                body: [
                    [
                        { text: 'Location', style: 'tableHeader' },
                        { text: 'Count', style: 'tableHeader' },
                        { text: 'Percentage', style: 'tableHeader' }
                    ],
                    ...topStations.map(s => [s.station, s.count.toString(), `${s.percentage.toFixed(1)}%`])
                ]
            },
            layout: 'lightHorizontalLines',
            margin: [0, 0, 0, 20]
        });
        return content;
    }
    generateStrategicSection(insights, recommendations) {
        const content = [
            { text: 'Section 3: Strategic Insights & Recommendations', style: 'header', margin: [0, 0, 0, 20] }
        ];
        content.push({ text: 'Strategic Recommendations', style: 'sectionTitle' });
        recommendations.forEach((rec, index) => {
            content.push({
                stack: [
                    {
                        text: `${index + 1}. ${rec.recommendation}`,
                        bold: true,
                        margin: [0, 10, 0, 5]
                    },
                    {
                        text: `Priority: ${rec.priority.toUpperCase()}`,
                        fontSize: 9,
                        color: rec.priority === 'high' ? '#dc3545' : rec.priority === 'medium' ? '#ffc107' : '#28a745'
                    },
                    {
                        text: rec.rationale,
                        margin: [0, 5, 0, 0],
                        style: 'body'
                    },
                    {
                        text: `Expected Impact: ${rec.impact}`,
                        fontSize: 9,
                        color: '#666666',
                        margin: [0, 5, 0, 0]
                    }
                ],
                margin: [0, 0, 0, 15]
            });
        });
        return content;
    }
    saveDefinition(reportData, outputPath) {
        const definition = this.generatePDFDocument(reportData);
        fs.writeFileSync(outputPath, JSON.stringify(definition, null, 2));
    }
}
exports.PDFGenerator = PDFGenerator;
exports.default = PDFGenerator;
//# sourceMappingURL=PDFGenerator.js.map